---
title: "lac"
author: "HÃ¥vard Crantz Lorentzen"
date: "28 9 2021"
output: html_document
---


```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(ggplot2)


dat<- read_excel("data til laktatprofil.xlsx", na="NA")


lactate <- dat %>%
  # Select columns needed for analysis
  select(FP, time, lac.75:lac.300) %>%
  # Only one participant and time-point
  filter(time == "pre", FP == 6) %>%
  # Pivot to long format data using the lactate columns
  pivot_longer(names_to = "watt", 
               values_to = "lactate", 
               names_prefix = "lac.",
               names_transform = list(watt = as.numeric),
               cols = lac.75:lac.300) %>%
   # Remove NA (missing) values to avoid warning/error messages.
  filter(!is.na(lactate))%>%
  # Plot the data, group = subject needed to connect the points
  ggplot(aes(watt, lactate, group = FP))  + 
  geom_line(lty = 2) +
  geom_point(shape = 21, fill = "lightblue", size = 2.5) +
# Adding straight lines at specific values
  geom_hline(yintercept = 4, color = "red") +
  geom_vline(xintercept = 341.5, color = "blue") + # Adding a straight line from a linear model
  geom_smooth(method = "lm", se = FALSE, formula = y ~ x, color = "#e41a1c") +

 # Adding a polynomial linear model to the plot
  
  # poly(x, 2) add a second degree polynomial model.
  geom_smooth(method = "lm", se = FALSE, formula = y ~ poly(x, 2), color = "#377eb8") +
  # poly(x, 3) add a third degree polynomial model.
  geom_smooth(method = "lm", se = FALSE, formula = y ~ poly(x, 3), color = "#4daf4a") +
  # poly(x, 4) add a forth degree polynomial model.
  geom_smooth(method = "lm", se = FALSE, formula = y ~ poly(x, 4), color = "#ff7f00") 
```


```{r}
library(tidyverse)
library(readxl)


dat<- read_excel("data til laktatprofil.xlsx", na="NA")


lactate <- dat %>%
  # Select columns needed for analysis
  select(FP, time, lac.75:lac.300) %>%
  # Only one participant and time-point
  filter(time == "pre", FP == 6) %>%
  # Pivot to long format data using the lactate columns
  pivot_longer(names_to = "watt", 
               values_to = "lactate", 
               names_prefix = "lac.",
               names_transform = list(watt = as.numeric),
               cols = lac.75:lac.300) %>%
   # Remove NA (missing) values to avoid warning/error messages.
  filter(!is.na(lactate))

# fit "straight line" model
m1 <- lm(lactate ~ watt, data = lactate)

# fit second degree polynomial
m2 <- lm(lactate ~ poly(watt, 2, raw = TRUE), data = lactate)

# fit third degree polynomial
m3 <- lm(lactate ~ poly(watt, 3, raw = TRUE), data = lactate)

# fit forth degree polynomial
m4 <- lm(lactate ~ poly(watt, 4, raw = TRUE), data = lactate)

# Store all residuals as new variables
lactate$resid.m1 <- resid(m1)
lactate$resid.m2 <- resid(m2)
lactate$resid.m3 <- resid(m3)
lactate$resid.m4 <- resid(m4)

lactate %>%
  # gather all the data from the models
  pivot_longer(names_to = "model", 
               values_to = "residual", 
               names_prefix = "resid.", 
               names_transform = list(residual = as.numeric), 
               cols = resid.m1:resid.m4) %>%
  # Plot values with the observed watt on x axis and residual values at the y
  ggplot(aes(watt, residual, fill = model)) + geom_point(shape = 21, size = 3) +
  
  # To set the same colors/fills as above we use scale fill manual
  scale_fill_manual(values = c("#e41a1c", "#377eb8", "#4daf4a", "#ff7f00"))


#new data data frame
ndf <- data.frame(watt = seq(from = 125, to = 275, by = 0.1)) # high resolution, we can find the nearest10:th a watt

ndf$predictions <- predict(m4, newdata = ndf)

lactate_threshold4 <- ndf %>%
  filter(abs(predictions - 4) == min(abs(predictions - 4)))
 
lactate_threshold2 <- ndf %>%
  filter(abs(predictions - 2) == min(abs(predictions - 2)))
```

